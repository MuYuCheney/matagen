import{d as Z,$ as Se,ab as X,v as k,U as Y,o as $,M as G,w as n,a as s,t as O,b as t,O as L,N as W,c as q,F as te,r as ae,u as oe,J as le,a0 as ne,ak as de,P as r,al as De,am as Ce,an as Ue,X as ce,Y as ie,af as Ie,_ as ue,ao as $e,ap as _e,aq as re,ar as Ae,as as Ve,at as pe,au as Ee,ag as Be,ah as me,Z as Fe,p as ge,e as ve,g as j,f as fe,ai as he,av as ke,m as ze,a2 as Ke}from"./index-0b8be2ed.js";import{S as Ne}from"./index-148e4a21.js";/* empty css                  *//* empty css                   *//* empty css                     */const ye=g=>{const w=g.substring(g.lastIndexOf(".")+1).toLowerCase();if(w=="md")return"markDown";if(w=="pdf")return"pdf";if(w=="doc"||w=="docx")return"word";if(w=="ppt"||w=="pptx")return"ppt"},D=g=>g&&g.length>0?g:[],z=g=>(ge("data-v-8b119c0e"),g=g(),ve(),g),Re={class:"dialog-title"},Te={class:"dialog-title-name"},Pe={class:"dialog-content"},Le={class:"add"},Oe=z(()=>s("div",{class:"add-text"},"上传文件",-1)),qe=z(()=>s("div",{class:"el-upload__text"},[s("div",{class:"el-upload__text1"},"点击或拖拽文件至此区域即可上传"),s("div",{class:"el-upload__text2"},"支持单次或批量上传，支持 PDF，Word，PPT，Markdown格式的文件")],-1)),Je={key:1,class:"kb-right-content"},Me={class:"grid-content ep-bg-purple"},Ge={class:"file-name"},Qe={class:"item-stategy"},We=z(()=>s("div",{class:"item-stategy-label"},"chunking_stategy 参数",-1)),Xe={class:"stategy-radio1"},Ye={class:"stategy-radio2"},Ze={key:0},je=z(()=>s("div",{class:"stategy-popover-A"},null,-1)),He=z(()=>s("div",{class:"stategy-popover-B"},null,-1)),es={class:"stategy-popover"},ss={class:"stategy-popover-row-content"},ts=z(()=>s("div",{class:"stategy-popover-row-content-label"},"chunk_size",-1)),as=z(()=>s("div",{class:"slider-demo-block-show"},"800",-1)),os={class:"stategy-popover-row-content"},ls=z(()=>s("div",{class:"stategy-popover-row-content-label"},"chunk__overlap_tokens",-1)),ns={class:"slider-demo-block-show"},ds={class:"dialog-footer group-btn"},cs=Z({__name:"AddDialog",emits:["showSessions"],setup(g,{expose:w,emit:K}){const B=Se(),e=X({showDialog:!1,formBtnLoading:!1,title:"新建知识库",kb_id:"",item:k(),isUpload:!1,isUpdate:!1,chunk_overlap_tokens_max:0}),S=X({knowledge_base_name:[{required:!0,message:"不能为空",trigger:"blur"}],chunking_strategy:[{required:!0,message:"不能为空",trigger:"blur"}],max_chunk_size_tokens:[{required:!0,message:"不能为空",trigger:"blur"}],chunk_overlap_tokens:[{required:!0,message:"不能为空",trigger:"blur"}]}),l=k({kb_id:"",knowledge_base_name:"",chunking_strategy:"auto",max_chunk_size_tokens:0,chunk_overlap_tokens:0,folder_path_base:""}),d=k({knowledge_new_name:"",init:!1}),C=k({folderName:""}),P=k(0),c=k([]),_=async o=>{var a,u,p,b,I,v,V,T,E,F,f,Q,M;if(e.showDialog=!0,e.isUpload=!1,l.value={knowledge_base_name:"",chunking_strategy:"auto",max_chunk_size_tokens:0,chunk_overlap_tokens:0,folder_path_base:""},c.value=[],e.title="新建知识库",e.isUpdate=!1,o)try{e.title="编辑知识库",e.isUpload=!0,e.isUpdate=!0,e.kb_id=o.id,e.item=o,l.value.knowledge_base_name=o.item.knowledge_base_name,l.value.chunking_strategy=o.item.chunking_strategy,l.value.max_chunk_size_tokens=o.item.max_chunk_size_tokens,l.value.chunk_overlap_tokens=o.item.chunk_overlap_tokens,l.value.folder_path_base="";const x=await de(e.kb_id);x.status===200&&((a=x.data)==null?void 0:a.status)===200&&(console.log("res.data.data"+JSON.stringify(x.data.data)),c.value=[...c.value,...D((p=(u=x.data.data)==null?void 0:u.data)==null?void 0:p[".md"])],c.value=[...c.value,...D((I=(b=x.data.data)==null?void 0:b.data)==null?void 0:I[".pdf"])],c.value=[...c.value,...D((V=(v=x.data.data)==null?void 0:v.data)==null?void 0:V[".doc"])],c.value=[...c.value,...D((E=(T=x.data.data)==null?void 0:T.data)==null?void 0:E[".docx"])],c.value=[...c.value,...D((f=(F=x.data.data)==null?void 0:F.data)==null?void 0:f[".ppt"])],c.value=[...c.value,...D((M=(Q=x.data.data)==null?void 0:Q.data)==null?void 0:M[".pptx"])])}catch(x){console.log(" error",x)}},i=()=>{},U=(o,a,u)=>{o.status===200?(P.value-=1,e.kb_id!=o.data.kb_id&&(e.kb_id=o.data.kb_id,c.value=[]),o.data.files.forEach(p=>{c.value.unshift(p)}),e.isUpload=!0):o.status===400?r({type:"error",message:o.data.message,customClass:"custom-message"}):r({type:"error",message:"文件上传失败",customClass:"custom-message"})},N=()=>{r({type:"error",message:"文件上传失败",customClass:"custom-message"})},J=o=>{if(!l.value.knowledge_base_name)return r({type:"error",message:"请填写知识库名称",customClass:"custom-message"}),!1;C.value.folderName=l.value.knowledge_base_name;const a=o.name.substring(o.name.lastIndexOf(".")+1).toLowerCase(),p=["md","pdf","doc","docx","ppt","pptx"].includes(a);return p||r({type:"error",message:"上传文件只能是 pdf,doc,docx,ppt,pptx,markdown",customClass:"custom-message"}),P.value+=1,p},m=async(o,a)=>{var p;const u=r({type:"info",message:"文件删除中...",customClass:"custom-loading-message"});try{let b=await De(a);b.status===200&&((p=b.data)==null?void 0:p.status)===200?(R("showSessions"),u.close(),r({type:"success",message:"文件删除成功！",customClass:"custom-message"}),c.value.splice(o,1)):(u.close(),r({type:"error",message:"文件删除失败，请重试！",customClass:"custom-message"}))}catch(b){u.close(),console.log("deleteKnowledgeFileAPI error",b),r({type:"error",message:"文件删除失败，请重试！",customClass:"custom-message"})}},y=async()=>{var a;if(!l.value.knowledge_base_name)return r({type:"error",message:"请填写知识库名称",customClass:"custom-message"}),!1;if(c.value.length==0)return r({type:"error",message:"请上传文件",customClass:"custom-message"}),!1;const o=r({type:"info",message:"知识库解析中...",customClass:"custom-loading-message"});try{let u;if(e.isUpdate)d.value.knowledge_new_name=l.value.knowledge_base_name,d.value.init=!1,u=await Ce(e.kb_id,d.value);else{const p=B.getThreadId();l.value.kb_id=e.kb_id,u=await Ue(p,l.value)}u.status===200&&((a=u.data)==null?void 0:a.status)===200?(R("showSessions"),o.close(),r({type:"success",message:"知识库解析成功！",customClass:"custom-message"}),e.showDialog=!1):(o.close(),r({type:"error",message:"知识库解析失败，请重试！",customClass:"custom-message"}))}catch(u){o.close(),console.log("createKnowledgeAPI error",u),r({type:"error",message:"知识库解析失败，请重试！",customClass:"custom-message"})}},A=async o=>{e.chunk_overlap_tokens_max=Math.floor(o/2),l.value.chunk_overlap_tokens=0};w({openDialog:_});const R=K;return(o,a)=>{const u=Y("Close"),p=ce,b=ie,I=Ie,v=ue,V=$e,T=Y("upload-filled"),E=_e,F=re,f=Ae,Q=Ve,M=pe,x=Ee,be=Be,ee=me,xe=Fe;return $(),G(xe,{class:"custom-dialog-alert",modelValue:e.showDialog,"onUpdate:modelValue":a[7]||(a[7]=h=>e.showDialog=h),width:"800px","align-center":!0,style:{background:"#13322f"},"show-close":!1},{title:n(()=>[s("div",Re,[s("div",Te,O(e.title),1),s("div",{class:"dialog-close",onClick:a[0]||(a[0]=h=>e.showDialog=!1)},[t(p,{size:16},{default:n(()=>[t(u)]),_:1})])])]),footer:n(()=>[s("div",ds,[t(ee,{class:"default-btn",onClick:a[5]||(a[5]=h=>e.showDialog=!1)},{default:n(()=>[L(" 取消 ")]),_:1}),t(ee,{class:"primary-btn",type:"primary",onClick:a[6]||(a[6]=h=>y())},{default:n(()=>[L(" 知识库解析 ")]),_:1})])]),default:n(()=>[s("div",Pe,[t(be,{ref:"formRef",rules:S,"label-position":"left",model:l.value,class:"demo-form-dialog","show-message":!1,style:{width:"max-content"},size:"large"},{default:n(()=>[t(I,{label:"知识库名称","label-width":130},{default:n(()=>[t(b,{class:"input-width",modelValue:l.value.knowledge_base_name,"onUpdate:modelValue":a[1]||(a[1]=h=>l.value.knowledge_base_name=h),placeholder:""},null,8,["modelValue"])]),_:1}),t(I,{label:"上传文件","label-width":110},{default:n(()=>[e.isUpload&&!e.isUpdate?($(),G(V,{key:0,class:"upload-demo",action:"/api/upload",multiple:"","show-file-list":!1,name:"files",accept:".md,.pdf,.doc,.docx,.ppt,.pptx","on-remove":i,"on-success":U,"on-error":N,"before-upload":J,data:C.value},{default:n(()=>[s("div",Le,[t(v,{"icon-class":"layoutAdd",className:"add-svg"}),Oe])]),_:1},8,["data"])):W("",!0)]),_:1}),e.isUpload?W("",!0):($(),G(V,{key:0,class:"upload-demo",drag:"",action:"/api/upload",multiple:"","show-file-list":!1,name:"files",accept:".md,.pdf,.doc,.docx,.ppt,.pptx","on-remove":i,"on-success":U,"before-upload":J,data:C.value},{default:n(()=>[t(p,{class:"el-icon--upload"},{default:n(()=>[t(T,{class:"el-icon--upload-svg"})]),_:1}),qe]),_:1},8,["data"])),e.isUpload?($(),q("div",Je,[t(F,{gutter:20},{default:n(()=>[($(!0),q(te,null,ae(c.value,(h,se)=>($(),G(E,{span:8,key:se},{default:n(()=>[s("div",Me,[t(v,{"icon-class":oe(ye)(h.filename),className:"pdf-svg"},null,8,["icon-class"]),s("span",Ge,O(h.filename),1),le(t(v,{"icon-class":"fileDelete",className:"file-delete",onClick:Us=>m(se,h.file_id)},null,8,["onClick"]),[[ne,!e.isUpdate]])])]),_:2},1024))),128))]),_:1})])):W("",!0),s("div",Qe,[We,t(Q,{modelValue:l.value.chunking_strategy,"onUpdate:modelValue":a[2]||(a[2]=h=>l.value.chunking_strategy=h),disabled:e.isUpdate},{default:n(()=>[s("div",Xe,[t(f,{value:"auto"},{default:n(()=>[L("自动")]),_:1})]),s("div",Ye,[t(f,{value:"static"},{default:n(()=>[L("手动")]),_:1})])]),_:1},8,["modelValue","disabled"]),l.value.chunking_strategy=="static"?($(),q("div",Ze,[je,He,s("div",es,[t(F,{class:"stategy-popover-row",gutter:54},{default:n(()=>[t(E,{span:10},{default:n(()=>[s("div",ss,[t(M,{"popper-class":"custom-tooltip",teleported:!1,effect:"dark",content:"每个块中允许的最大Token数，该参数控制每次分块时包含的文本量",placement:"bottom"},{default:n(()=>[ts]),_:1}),t(x,{class:"stategy-popover-row-content-slider",modelValue:l.value.max_chunk_size_tokens,"onUpdate:modelValue":a[3]||(a[3]=h=>l.value.max_chunk_size_tokens=h),min:0,max:800,disabled:e.isUpdate,onChange:A},null,8,["modelValue","disabled"]),as])]),_:1}),t(E,{span:12},{default:n(()=>[s("div",os,[t(M,{"popper-class":"custom-tooltip",teleported:!1,content:"相邻块之间的重叠Token数，防止分块之间的上下文丢失",placement:"bottom"},{default:n(()=>[ls]),_:1}),t(x,{class:"stategy-popover-row-content-slider",modelValue:l.value.chunk_overlap_tokens,"onUpdate:modelValue":a[4]||(a[4]=h=>l.value.chunk_overlap_tokens=h),min:0,max:e.chunk_overlap_tokens_max,disabled:e.isUpdate},null,8,["modelValue","max","disabled"]),s("div",ns,O(e.chunk_overlap_tokens_max),1)])]),_:1})]),_:1})])])):W("",!0)])]),_:1},8,["rules","model"])])]),_:1},8,["modelValue"])}}});const we=j(cs,[["__scopeId","data-v-8b119c0e"]]),H=g=>(ge("data-v-3d621191"),g=g(),ve(),g),is={class:"kb-detail"},us={class:"kb-right-top"},_s=H(()=>s("div",{class:"kb-right-top-title"},"文件列表",-1)),rs={class:"kb-right-search"},ps={class:"kb-right-content"},ms={class:"grid-content ep-bg-purple"},gs={class:"file-name"},vs={class:"file-content"},fs=H(()=>s("span",{class:"file-content-name"},"chunking_stategy 参数：",-1)),hs={class:"file-content-type"},ks=H(()=>s("span",null,"手动",-1)),ys={class:"tool-tips"},ws={class:"group-btn"},bs=Z({__name:"Detail",emits:["showSessions"],setup(g,{expose:w,emit:K}){const B=k();fe();const e=X({showDialog:!1,kb_id:"",item:k()}),S=k({kb_id:"",knowledge_base_name:"",chunking_strategy:"auto",max_chunk_size_tokens:0,chunk_overlap_tokens:0,folder_path_base:""}),l=k(""),d=k([]),C=k([]),P=()=>{l.value?C.value=d.value.filter(m=>m.filename.substring(0,m.filename.lastIndexOf(".")).indexOf(l.value)!==-1):C.value=d.value},c=async m=>{var y,A,R,o,a,u,p,b,I,v,V,T,E,F;if(!m){r({type:"error",message:"参数异常",customClass:"custom-message"});return}try{e.kb_id=m.id,e.item=m,S.value.knowledge_base_name=m.item.knowledge_base_name,S.value.chunking_strategy=m.item.chunking_strategy,S.value.max_chunk_size_tokens=m.item.max_chunk_size_tokens,S.value.chunk_overlap_tokens=m.item.chunk_overlap_tokens,S.value.folder_path_base="",e.showDialog=!0,d.value=[],C.value=[];const f=await de(e.kb_id);f.status===200&&((y=f.data)==null?void 0:y.status)===200&&(console.log("res.data.data.data"+JSON.stringify((A=f.data.data)==null?void 0:A.data)),d.value=[...d.value,...D((o=(R=f.data.data)==null?void 0:R.data)==null?void 0:o[".md"])],d.value=[...d.value,...D((u=(a=f.data.data)==null?void 0:a.data)==null?void 0:u[".pdf"])],d.value=[...d.value,...D((b=(p=f.data.data)==null?void 0:p.data)==null?void 0:b[".doc"])],d.value=[...d.value,...D((v=(I=f.data.data)==null?void 0:I.data)==null?void 0:v[".docx"])],d.value=[...d.value,...D((T=(V=f.data.data)==null?void 0:V.data)==null?void 0:T[".ppt"])],d.value=[...d.value,...D((F=(E=f.data.data)==null?void 0:E.data)==null?void 0:F[".pptx"])],C.value=d.value)}catch(f){console.log(" error",f)}},_=async()=>{e.showDialog=!1},i=async m=>{he.confirm("确认后该知识库会被删除，且不可恢复","确认删除？",{confirmButtonText:"确认",cancelButtonText:"取消",type:"info",customClass:"custom-message-box"}).then(async()=>{var y;try{const A=await ke(m);A.status===200&&((y=A.data)==null?void 0:y.status)===200&&(r({type:"success",message:"知识库删除成功",customClass:"custom-message"}),J("showSessions"),e.showDialog=!1)}catch{r({type:"error",message:"知识库删除失败",customClass:"custom-message"})}}).catch(()=>{})},U=async()=>{var m;(m=B.value)==null||m.openDialog(e.item)},N=()=>{J("showSessions")};w({openDetail:c,closeDetail:_});const J=K;return(m,y)=>{const A=Y("search"),R=ce,o=ie,a=ue,u=pe,p=_e,b=re,I=me;return le(($(),q("div",is,[s("div",us,[_s,s("div",rs,[t(o,{class:"kb-right-search-input",modelValue:l.value,"onUpdate:modelValue":y[0]||(y[0]=v=>l.value=v),placeholder:"请输入文件名称",onInput:P},{suffix:n(()=>[t(R,{class:"el-input__icon"},{default:n(()=>[t(A)]),_:1})]),_:1},8,["modelValue"])])]),s("div",ps,[t(b,{gutter:20},{default:n(()=>[($(!0),q(te,null,ae(C.value,(v,V)=>($(),G(p,{span:8,key:V},{default:n(()=>[s("div",ms,[t(a,{"icon-class":oe(ye)(v.filename),className:"pdf-svg"},null,8,["icon-class"]),t(u,{class:"box-item",effect:"dark",content:v.filename,placement:"top"},{default:n(()=>[s("span",gs,O(v.filename),1)]),_:2},1032,["content"])])]),_:2},1024))),128))]),_:1})]),s("div",vs,[fs,s("div",hs,[ks,s("div",ys," chunk_size："+O(S.value.max_chunk_size_tokens)+"    chunk__overlap_tokens："+O(S.value.chunk_overlap_tokens),1)])]),s("div",ws,[t(I,{class:"primary-btn",type:"primary",onClick:y[1]||(y[1]=v=>U())},{default:n(()=>[L(" 编辑 ")]),_:1}),t(I,{class:"default-btn",plain:"",onClick:y[2]||(y[2]=v=>i(e.kb_id))},{default:n(()=>[L(" 删除 ")]),_:1})]),t(we,{ref_key:"AddDialogRef",ref:B,onShowSessions:N},null,512)],512)),[[ne,e.showDialog]])}}});const xs=j(bs,[["__scopeId","data-v-3d621191"]]),Ss={class:"kb"},Ds={class:"kb-right"},Cs=Z({__name:"index",setup(g){const w=k(),K=k();fe(),k("");const B=k([]),e=async()=>{var _;try{B.value=[];const i=await Ke();i.status===200&&((_=i.data)==null?void 0:_.status)===200&&i.data.data&&i.data.data.length>0&&(B.value=i.data.data.map(U=>({id:U.knowledge_base_id,name:U.knowledge_base_name,item:U})))}catch(i){console.log("getAllKnowledgeAPI error",i)}},S=()=>{e()},l=()=>{var _;(_=K.value)==null||_.openDialog()},d=_=>{var i;console.log("querySession"+JSON.stringify(_)),(i=w.value)==null||i.openDetail(_)},C=_=>{var i;console.log("editSession"+JSON.stringify(_)),(i=K.value)==null||i.openDialog(_)},P=_=>{console.log("deleteSession"+JSON.stringify(_)),c(_.id)},c=async _=>{he.confirm("确认后该知识库会被删除，且不可恢复","确认删除？",{confirmButtonText:"确认",cancelButtonText:"取消",type:"info",customClass:"custom-message-box"}).then(async()=>{var i,U;try{const N=await ke(_);N.status===200&&((i=N.data)==null?void 0:i.status)===200&&(r({type:"success",message:"知识库删除成功",customClass:"custom-message"}),e(),(U=w.value)==null||U.closeDetail())}catch{r({type:"error",message:"知识库删除失败",customClass:"custom-message"})}}).catch(()=>{r({type:"error",message:"知识库删除失败",customClass:"custom-message"})})};return ze(()=>{e()}),(_,i)=>($(),q("div",Ss,[t(Ne,{title:"添加知识库",list:B.value,onAddSession:l,onQuerySession:d,onEditSession:C,onDeleteSession:P},null,8,["list"]),s("div",Ds,[t(xs,{ref_key:"DetailRef",ref:w,onShowSessions:S},null,512)]),t(we,{ref_key:"AddDialogRef",ref:K,onShowSessions:S},null,512)]))}});const Bs=j(Cs,[["__scopeId","data-v-5df8ed51"]]);export{Bs as default};
