import{d as x,v as g,ab as S,J as R,a0 as U,o as V,c as A,b as l,w as c,a as I,Q as C,P as u,ac as B,ad as N,ae as q,af as P,Y as $,ag as J,ah as T,ai as F,g as E,m as O,a7 as M,aj as Q,f as j,ak as z}from"./index-4de10589.js";import{S as H}from"./index-f49f89aa.js";const L={class:"db-detail"},Y={class:"group-btn"},G=x({__name:"Detail",emits:["showSessions"],setup(k,{expose:p,emit:_}){const m=g(),n=S({showDialog:!1,db_id:""}),t=g({hostname:"",port:"",username:"",password:"",database_name:""}),f=S({hostname:[{required:!0,message:"不能为空",trigger:"blur"}],port:[{required:!0,message:"不能为空",trigger:"blur"}],username:[{required:!0,message:"不能为空",trigger:"blur"}],password:[{required:!0,message:"不能为空",trigger:"blur"}],database_name:[{required:!0,message:"不能为空",trigger:"blur"}]}),y=async()=>{n.showDialog=!1},v=async i=>{var a,s;if(!i){u({type:"error",message:"参数异常",customClass:"custom-message"});return}try{(a=m.value)==null||a.resetFields(),n.db_id=i;const e=await B(n.db_id);e.status===200&&((s=e.data)==null?void 0:s.status)===200&&(t.value.hostname=e.data.data.db_info.hostname,t.value.port=e.data.data.db_info.port+"",t.value.username=e.data.data.db_info.username,t.value.password=e.data.data.db_info.password,t.value.database_name=e.data.data.db_info.database_name,n.showDialog=!0)}catch(e){console.log("getDbInfoAPI error",e)}},w=async i=>{i&&await i.validate(async(a,s)=>{var e;if(a){const r=u({type:"info",message:"数据库保存中...",customClass:"custom-loading-message"});try{const d=await N(n.db_id,t.value);d.status===200&&((e=d.data)==null?void 0:e.status)===200?(b("showSessions"),r.close(),u({type:"success",message:"数据库保存成功！",customClass:"custom-message"})):(r.close(),u({type:"error",message:"数据库保存失败，请重试！",customClass:"custom-message"}))}catch(d){r.close(),console.log("updateDbConnectionAPI error",d),u({type:"error",message:"数据库连接失败，请重试！",customClass:"custom-message"})}}})},h=async i=>{q.confirm("确认后该数据库连接会被删除，且不可恢复","确认删除？",{confirmButtonText:"确认",cancelButtonText:"取消",type:"info",customClass:"custom-message-box"}).then(async()=>{var a;try{const s=await P(i);s.status===200&&((a=s.data)==null?void 0:a.status)===200&&(u({type:"success",message:"数据库连接删除成功",customClass:"custom-message"}),b("showSessions"),n.showDialog=!1)}catch{u({type:"error",message:"数据库连接删除失败",customClass:"custom-message"})}}).catch(()=>{})};p({openDetail:v,closeDetail:y});const b=_;return(i,a)=>{const s=$,e=J,r=T,d=F;return R((V(),A("div",L,[l(d,{ref_key:"formRef",ref:m,rules:f,model:t.value,class:"demo-form-dialog",style:{width:"max-content"},size:"large","label-width":72},{default:c(()=>[l(e,{label:"Host",prop:"hostname"},{default:c(()=>[l(s,{class:"input-width",modelValue:t.value.hostname,"onUpdate:modelValue":a[0]||(a[0]=o=>t.value.hostname=o),placeholder:""},null,8,["modelValue"])]),_:1}),l(e,{label:"Port",prop:"port"},{default:c(()=>[l(s,{class:"input-width",modelValue:t.value.port,"onUpdate:modelValue":a[1]||(a[1]=o=>t.value.port=o),placeholder:""},null,8,["modelValue"])]),_:1}),l(e,{label:"User",prop:"username"},{default:c(()=>[l(s,{class:"input-width",modelValue:t.value.username,"onUpdate:modelValue":a[2]||(a[2]=o=>t.value.username=o),placeholder:""},null,8,["modelValue"])]),_:1}),l(e,{label:"Pwd",prop:"password"},{default:c(()=>[l(s,{class:"input-width",type:"password",modelValue:t.value.password,"onUpdate:modelValue":a[3]||(a[3]=o=>t.value.password=o),placeholder:"","show-password":""},null,8,["modelValue"])]),_:1}),l(e,{label:"db_name",prop:"database_name"},{default:c(()=>[l(s,{class:"input-width",modelValue:t.value.database_name,"onUpdate:modelValue":a[4]||(a[4]=o=>t.value.database_name=o),placeholder:""},null,8,["modelValue"])]),_:1}),l(e,null,{default:c(()=>[I("div",Y,[l(r,{class:"primary-btn",type:"primary",onClick:a[5]||(a[5]=o=>w(m.value))},{default:c(()=>[C("保存")]),_:1}),l(r,{class:"default-btn",plain:"",onClick:a[6]||(a[6]=o=>h(n.db_id))},{default:c(()=>[C(" 删除")]),_:1})])]),_:1})]),_:1},8,["rules","model"])],512)),[[U,n.showDialog]])}}});const K=E(G,[["__scopeId","data-v-e2658bee"]]),W={class:"db"},X={class:"db-right"},Z=x({__name:"index",setup(k){const p=g(),_=g();j();const m=g([]),n=g({hostname:"",port:"",username:"",password:"",database_name:""}),t=async()=>{var s;m.value=[];try{const e=await M();e.status===200&&((s=e.data)==null?void 0:s.status)===200&&e.data.data&&e.data.data.length>0&&(m.value=e.data.data.map(r=>({id:r.id,name:r.database_name})))}catch(e){console.log("createDbConnectionAPI error",e)}},f=()=>{var s;t(),(s=_.value)==null||s.closeDetail()},y=()=>{var s;(s=p.value)==null||s.openDialog()},v=s=>{var e;console.log("querySession"+JSON.stringify(s)),(e=_.value)==null||e.openDetail(s.id)},w=async s=>{var r,d;console.log("editSessionName"+JSON.stringify(s));const e=u({type:"info",message:"数据库重命名中...",customClass:"custom-loading-message"});try{let o=await B(s.id);if(o.status===200&&((r=o.data)==null?void 0:r.status)===200){n.value.hostname=o.data.data.db_info.hostname,n.value.port=o.data.data.db_info.port+"",n.value.username=o.data.data.db_info.username,n.value.password=o.data.data.db_info.password,n.value.database_name=s.name;let D=await N(s.id,n.value);D.status===200&&((d=D.data)==null?void 0:d.status)===200?(e.close(),u({type:"success",message:"数据库重命名成功！",customClass:"custom-message"}),f()):(e.close(),u({type:"error",message:"数据库重命名失败，请重试！",customClass:"custom-message"}))}}catch(o){e.close(),console.log("editSessionName error",o),u({type:"error",message:"数据库重命名失败，请重试！",customClass:"custom-message"})}},h=s=>{var e;console.log("editSession"+JSON.stringify(s)),(e=p.value)==null||e.openDialog(s.id)},b=async s=>{console.log("deleteSession"+JSON.stringify(s)),i(s.id)},i=async s=>{q.confirm("确认后该数据库连接会被删除，且不可恢复","确认删除？",{confirmButtonText:"确认",cancelButtonText:"取消",type:"info",customClass:"custom-message-box"}).then(async()=>{var e,r;try{const d=await P(s);d.status===200&&((e=d.data)==null?void 0:e.status)===200&&(u({type:"success",message:"数据库连接删除成功",customClass:"custom-message"}),t(),(r=_.value)==null||r.closeDetail())}catch{u({type:"error",message:"数据库连接删除失败",customClass:"custom-message"})}}).catch(()=>{})},a=Q();return O(()=>{var s;if(console.log("db init",a.query.type),a.query.type&&a.query.type==="add"){(s=p.value)==null||s.openDialog();const e=window.location.hash.replace(/\?.*$/,"");history.replaceState({},"",e)}t()}),(s,e)=>(V(),A("div",W,[l(H,{title:"添加数据库",list:m.value,onAddSession:y,onQuerySession:v,onEditSession:h,onEditSessionName:w,onDeleteSession:b},null,8,["list"]),I("div",X,[l(K,{ref_key:"DetailRef",ref:_,onShowSessions:f},null,512)]),l(z,{ref_key:"AddDialogRef",ref:p,onShowSessions:f},null,512)]))}});const ae=E(Z,[["__scopeId","data-v-1e134e98"]]);export{ae as default};
